import matplotlib.pyplot as plt
import numpy as np
from scipy.interpolate import CubicSpline
import pandas as pd
import os
import math
plt.rcParams['xtick.labelsize'] = 20
plt.rcParams['ytick.labelsize'] = 20
plt.rcParams['legend.fontsize'] = 12
temp=16

def extract_data(data):
  low_s=pd.read_csv(data[0])
  high_s=pd.read_csv(data[1])
  low=[np.array(low_s['lam']), np.array(low_s['fluxo'])]
  high=[np.array(high_s['lam']), np.array(high_s['fluxo'])]
  return(low, high)

def plota_spec(ref, observado, base, alfa, imf, info, nome_linha):
  centralmin, centralmax, bluemin, bluemax, redmin, redmax= info['info'].iloc[0],info['info'].iloc[1],info['info'].iloc[2],info['info'].iloc[3],info['info'].iloc[4],info['info'].iloc[5],
  observado_l, observado_h=extract_data(observado)
  base_l, base_h=extract_data(base)
  imf_h, imf_l=extract_data(imf)
  alfa_l, alfa_h=extract_data(alfa)
  ref_x, ref_y=ref['lam'], ref['fluxo'] 
  fig, (ax1, ax2)=plt.subplots(nrows=2,ncols=1)
  fig.suptitle(nome_linha, fontsize=25)
  ax1.plot(ref_x, ref_y, color='xkcd:dusty blue', lw=0.8)
  ax1.plot(base_l[0], base_l[1], color='xkcd:black')
  ax1.plot(alfa_l[0], alfa_l[1], color='xkcd:primary blue')
  ax1.plot(imf_l[0], imf_l[1], color='xkcd:cherry red')
  ax1.plot(observado_l[0], observado_l[1], color='xkcd:green', ls='dashed', lw=2.5)
  ax1.set_xlim(bluemin-5, redmax+5)
  ax1.legend(labels=[r'Sintético', r'Base', r'$[α/Fe]$', r'IMF', r'Observado']  ,loc="lower right")
  ax1.set_xlabel(r' $\lambda$($\AA$)', fontsize=22)
  ax1.set_ylabel(r'Fluxo Normalizado', fontsize=22)
  ax1.set_ylim(0.55, 1.1)
  ax1.fill_betweenx([0,1.2], bluemin, bluemax, facecolor='xkcd:gunmetal', edgecolor='black', alpha=0.4)
  ax1.fill_betweenx([0,1.2], centralmin, centralmax, facecolor='xkcd:greyish', edgecolor='black', alpha=0.4)
  ax1.fill_betweenx([0,1.2], redmin, redmax, facecolor='xkcd:gunmetal',edgecolor='black', alpha=0.4)
  ax1.text(bluemax+2.5, 0.57, r'σ=180km/s', fontsize=18)

  ax2.plot(ref_x, ref_y, color='xkcd:dusty blue', lw=0.8)
  ax2.plot(base_h[0], base_h[1], color='xkcd:black')
  ax2.plot(alfa_h[0], alfa_h[1], color='xkcd:primary blue')
  ax2.plot(imf_h[0], imf_h[1], color='xkcd:cherry red')
  ax2.plot(observado_h[0], observado_h[1], color='xkcd:green', ls='dashed', lw=2.5)
  ax2.set_xlim(bluemin-5, redmax+5)
  ax2.legend(labels=[r'Sintético', r'Base', r'$[α/Fe]$', r'IMF', r'Observado']  ,loc="lower right")
  ax2.set_xlabel(r' $\lambda$($\AA$)', fontsize=22)
  ax2.set_ylabel(r'Fluxo Normalizado', fontsize=22)
  ax2.set_ylim(0.55, 1.1)
  ax2.fill_betweenx([0,1.2], bluemin, bluemax, facecolor='xkcd:gunmetal', edgecolor='black', alpha=0.4)
  ax2.fill_betweenx([0,1.2], centralmin, centralmax, facecolor='xkcd:greyish', edgecolor='black', alpha=0.4)
  ax2.fill_betweenx([0,1.2], redmin, redmax, facecolor='xkcd:gunmetal',edgecolor='black', alpha=0.4)
  ax2.text(bluemax+2.5,0.57, r'σ=300km/s', fontsize=18)
  plt.subplots_adjust(hspace=0.4)
  fig.set_figheight(8)
  fig.set_figwidth(20)
  fig.savefig(nome_linha+'.png', bbox_inches='tight')

def plota_region(ref, observado, base, alfa, imf, info, nome_linha):
  centralmin, centralmax, bluemin, bluemax, redmin, redmax= info['info'].iloc[0],info['info'].iloc[1],info['info'].iloc[2],info['info'].iloc[3],info['info'].iloc[4],info['info'].iloc[5],
  observado_l, observado_h=extract_data(observado)
  base_l, base_h=extract_data(base)
  imf_h, imf_l=extract_data(imf)
  alfa_l, alfa_h=extract_data(alfa)
  ref_x, ref_y=ref['lam'], ref['fluxo'] 
  fig, (ax1, ax2)=plt.subplots(nrows=2,ncols=1)
  fig.suptitle(nome_linha, fontsize=25)
  ax1.plot(ref_x, ref_y, color='xkcd:dusty blue', lw=0.8)
  ax1.plot(base_l[0], base_l[1], color='xkcd:black')
  ax1.plot(alfa_l[0], alfa_l[1], color='xkcd:primary blue')
  ax1.plot(imf_l[0], imf_l[1], color='xkcd:cherry red')
  ax1.plot(observado_l[0], observado_l[1], color='xkcd:green', ls='dashed', lw=2.5)
  '''
  #TiO1
  ax1.scatter([5941.78, 5948.55, 5952.9, 5956.7, 5965.87, 5975.38, 5978.6, 5984.8], [0.84, 0.78, 0.75, 0.77, 0.78, 0.74, 0.82, 0.731], marker="|", c='xkcd:black', s=50)
  ax1.text( 5941.5, 0.78,'Ti I', rotation='vertical',fontsize=temp)
  ax1.text( 5948.3, 0.72, 'Si I', rotation='vertical',fontsize=temp)
  ax1.text( 5952.65, 0.68, 'Fe I', rotation='vertical',fontsize=temp)
  ax1.text( 5956.5, 0.70, 'Fe I', rotation='vertical',fontsize=temp)  
  ax1.text( 5965.6, 0.72,'Ti I', rotation='vertical',fontsize=temp)
  ax1.text( 5975.1, 0.67, 'Fe I', rotation='vertical',fontsize=temp)
  ax1.text( 5978.39, 0.76,'Ti I', rotation='vertical',fontsize=temp)
  ax1.text( 5984.5, 0.66, 'Fe I', rotation='vertical',fontsize=temp)
  #CaT
  ax1.scatter([8526.72, 8536.13, 8548.07, 8550.8, 8556.8],[0.81, 0.81, 0.79,0.83, 0.73] , marker="|", c='xkcd:black', s=50)
  ax1.text( 8526.55 , 0.73,'Fe I', rotation='vertical',fontsize=temp)
  ax1.text( 8535.95, 0.74, 'Si I', rotation='vertical',fontsize=temp)
  ax1.text( 8547.9, 0.72, 'Ti I', rotation='vertical',fontsize=temp)
  ax1.text( 8550.67, 0.76, 'Si I', rotation='vertical',fontsize=temp)  
  ax1.text( 8556.64, 0.668,'Si I', rotation='vertical',fontsize=temp)
  #Na8190
  ax1.scatter([8181.13, 8186.8, 8184.6, 8188.1, 8192.75, 8196.9],[0.87, 0.83, 0.89, 0.81, 0.85, 0.89] , marker="|", c='xkcd:black', s=50)
  ax1.text( 8181.02, 0.72, 'CN Red', rotation='vertical',fontsize=temp)
  ax1.text( 8186.72 , 0.75,'Fe I', rotation='vertical',fontsize=temp)
  ax1.text( 8184.49, 0.74, 'CN Red', rotation='vertical',fontsize=temp)
  ax1.text( 8188, 0.66, 'CN Red', rotation='vertical',fontsize=temp)  
  ax1.text( 8192.65, 0.7,'CN Red', rotation='vertical',fontsize=temp)
  ax1.text( 8196.8, 0.74,'CN Red', rotation='vertical',fontsize=temp)
  #TiO2
  ax1.scatter([6191.5, 6199.25, 6200.27, 6204.65, 6207.26, 6213.42, 6215.3, 6219.3, 6220.55,  6224.17, 6230.8, 6232.6, 6240.59, 6242.98, 6246.34, 6252.57, 6254.24, 6256.4, 6258.7, 6261.25],[0.55,0.82, 0.74, 0.85, 0.8, 0.69, 0.66, 0.66,0.83, 0.75, 0.56, 0.67, 0.71, 0.72, 0.66, 0.65, 0.64, 0.69, 0.64, 0.74], marker="|", c='xkcd:black', s=50)
  ax1.text( 6191.2, 0.465, 'Fe I', rotation='vertical',fontsize=temp)
  ax1.text( 6198.8, 0.72, 'Ti II', rotation='vertical',fontsize=temp)
  ax1.text( 6200 , 0.65,'Fe I', rotation='vertical',fontsize=temp)
  ax1.text( 6204.3, 0.77, 'Ni I', rotation='vertical',fontsize=temp)
  ax1.text( 6206.9, 0.71, 'Fe I', rotation='vertical',fontsize=temp) 
  ax1.text( 6212.9, 0.6, 'Fe I', rotation='vertical',fontsize=temp)
  ax1.text( 6215, 0.58, 'Fe I', rotation='vertical',fontsize=temp)
  ax1.text( 6219, 0.58, 'Fe I', rotation='vertical',fontsize=temp)
  ax1.text( 6220.2, 0.76, 'Ti I', rotation='vertical',fontsize=temp)
  ax1.text( 6223.7, 0.67,'Ni I', rotation='vertical',fontsize=temp)
  ax1.text( 6230.35, 0.47, 'Fe I', rotation='vertical',fontsize=temp)
  ax1.text( 6232.3, 0.58, 'Fe I', rotation='vertical',fontsize=temp)
  ax1.text( 6240.2, 0.62, 'Fe I', rotation='vertical',fontsize=temp)
  ax1.text( 6242.57, 0.65, 'V I', rotation='vertical',fontsize=temp)
  ax1.text( 6245.92, 0.57, 'Fe I', rotation='vertical',fontsize=temp)
  ax1.text( 6252.2, 0.565, 'Fe I', rotation='vertical',fontsize=temp)
  ax1.text( 6253.9, 0.465, 'Fe I/Si I', rotation='vertical',fontsize=temp)
  ax1.text( 6256.06, 0.51, 'Fe I/Ni I', rotation='vertical',fontsize=temp)
  ax1.text( 6258.32, 0.465, 'Fe I/Ni I', rotation='vertical',fontsize=temp)
  ax1.text( 6260.9, 0.66, 'Ti I', rotation='vertical',fontsize=temp)     
  '''
  ax1.scatter([8181.13, 8186.8,8183.26, 8184.6, 8188.1, 8192.75,8194.8, 8196.9],[0.87, 0.83, 0.7, 0.89, 0.81, 0.85,0.7, 0.89] , marker="|", c='xkcd:black', s=50)
  ax1.text( 8181.02, 0.72, 'CN Red', rotation='vertical',fontsize=temp)
  ax1.text( 8186.72 , 0.75,'Fe I', rotation='vertical',fontsize=temp)
  ax1.text( 8184.49, 0.74, 'CN Red', rotation='vertical',fontsize=temp)
  ax1.text( 8188, 0.66, 'CN Red', rotation='vertical',fontsize=temp)  
  ax1.text( 8192.65, 0.7,'CN Red', rotation='vertical',fontsize=temp)
  ax1.text( 8196.8, 0.74,'CN Red', rotation='vertical',fontsize=temp)
  ax1.text( 8183.15, 0.74,'Na I', rotation='vertical',fontsize=temp)
  ax1.text( 8194.7, 0.74,'Na I', rotation='vertical',fontsize=temp)
  ax1.set_xticks([8180, 8185, 8190, 8195,8200])
  ax1.set_xlim(centralmin, centralmax)
  ax1.legend(labels=[r'Sintético', r'Base', r'$[α/Fe]$', r'IMF', r'Observado']  ,loc="lower right")
  ax1.set_xlabel(r' $\lambda$($\AA$)', fontsize=22)
  ax1.set_ylabel(r'Fluxo Normalizado', fontsize=22)
  ax1.set_ylim(0.65, 1.1)
  ax1.fill_betweenx([0,1.2], bluemin, bluemax, facecolor='xkcd:gunmetal', edgecolor='black', alpha=0.4)
  ax1.fill_betweenx([0,1.2], centralmin, centralmax, facecolor='xkcd:greyish', edgecolor='black', alpha=0.4)
  ax1.fill_betweenx([0,1.2], redmin, redmax, facecolor='xkcd:gunmetal',edgecolor='black', alpha=0.4)
  ax1.text(centralmin+5, 0.67, r'σ=180km/s', fontsize=18)

  ax2.plot(ref_x, ref_y, color='xkcd:dusty blue', lw=0.8)
  ax2.plot(base_h[0], base_h[1], color='xkcd:black')
  ax2.plot(alfa_h[0], alfa_h[1], color='xkcd:primary blue')
  ax2.plot(imf_h[0], imf_h[1], color='xkcd:cherry red')
  ax2.plot(observado_h[0], observado_h[1], color='xkcd:green', ls='dashed', lw=2.5)
  '''
  #TiO1
  ax2.scatter([5941.78, 5948.55, 5952.9, 5956.7, 5965.87, 5975.38, 5978.6, 5984.8], [0.84, 0.78, 0.75, 0.77, 0.78, 0.74, 0.82, 0.731], marker="|", c='xkcd:black', s=50)
  ax2.text( 5941.5, 0.78,'Ti I', rotation='vertical',fontsize=temp)
  ax2.text( 5948.3, 0.72, 'Si I', rotation='vertical',fontsize=temp)
  ax2.text( 5952.65, 0.68, 'Fe I', rotation='vertical',fontsize=temp)
  ax2.text( 5956.5, 0.70, 'Fe I', rotation='vertical',fontsize=temp)  
  ax2.text( 5965.6, 0.72,'Ti I', rotation='vertical',fontsize=temp)
  ax2.text( 5975.1, 0.67, 'Fe I', rotation='vertical',fontsize=temp)
  ax2.text( 5978.39, 0.76,'Ti I', rotation='vertical',fontsize=temp)
  ax2.text( 5984.5, 0.66, 'Fe I', rotation='vertical',fontsize=temp)
  #CaT
  ax2.scatter([8526.72, 8536.13, 8548.07, 8550.8, 8556.8],[0.81, 0.81, 0.79,0.83, 0.73] , marker="|", c='xkcd:black', s=50)
  ax2.text( 8526.55 , 0.73,'Fe I', rotation='vertical',fontsize=temp)
  ax2.text( 8535.95, 0.74, 'Si I', rotation='vertical',fontsize=temp)
  ax2.text( 8547.9, 0.72, 'Ti I', rotation='vertical',fontsize=temp)
  ax2.text( 8550.67, 0.76, 'Si I', rotation='vertical',fontsize=temp)  
  ax2.text( 8556.64, 0.668,'Si I', rotation='vertical',fontsize=temp)
  #Na8190
  ax2.scatter([8181.13, 8186.8, 8184.6, 8188.1, 8192.75, 8196.9],[0.87, 0.83, 0.89, 0.81, 0.85, 0.89] , marker="|", c='xkcd:black', s=50)
  ax2.text( 8181.02, 0.72, 'CN Red', rotation='vertical',fontsize=temp)
  ax2.text( 8186.72 , 0.75,'Fe I', rotation='vertical',fontsize=temp)
  ax2.text( 8184.49, 0.74, 'CN Red', rotation='vertical',fontsize=temp)
  ax2.text( 8188, 0.66, 'CN Red', rotation='vertical',fontsize=temp)  
  ax2.text( 8192.65, 0.7,'CN Red', rotation='vertical',fontsize=temp)
  ax2.text( 8196.8, 0.74,'CN Red', rotation='vertical',fontsize=temp)
  #TiO2
  ax2.scatter([6191.5, 6199.25, 6200.27, 6204.65, 6207.26, 6213.42, 6215.3, 6219.3, 6220.55,  6224.17, 6230.8, 6232.6, 6240.59, 6242.98, 6246.34, 6252.57, 6254.24, 6256.4, 6258.7, 6261.25],[0.55,0.82, 0.74, 0.85, 0.8, 0.69, 0.66, 0.66,0.83, 0.75, 0.56, 0.67, 0.71, 0.72, 0.66, 0.65, 0.64, 0.69, 0.64, 0.74], marker="|", c='xkcd:black', s=50)
  ax2.text( 6191.2, 0.465, 'Fe I', rotation='vertical',fontsize=temp)
  ax2.text( 6198.8, 0.72, 'Ti II', rotation='vertical',fontsize=temp)
  ax2.text( 6200 , 0.65,'Fe I', rotation='vertical',fontsize=temp)
  ax2.text( 6204.3, 0.77, 'Ni I', rotation='vertical',fontsize=temp)
  ax2.text( 6206.9, 0.71, 'Fe I', rotation='vertical',fontsize=temp) 
  ax2.text( 6212.9, 0.6, 'Fe I', rotation='vertical',fontsize=temp)
  ax2.text( 6215, 0.58, 'Fe I', rotation='vertical',fontsize=temp)
  ax2.text( 6219, 0.58, 'Fe I', rotation='vertical',fontsize=temp)
  ax2.text( 6220.2, 0.76, 'Ti I', rotation='vertical',fontsize=temp)
  ax2.text( 6223.7, 0.67,'Ni I', rotation='vertical',fontsize=temp)
  ax2.text( 6230.35, 0.47, 'Fe I', rotation='vertical',fontsize=temp)
  ax2.text( 6232.3, 0.58, 'Fe I', rotation='vertical',fontsize=temp)
  ax2.text( 6240.2, 0.62, 'Fe I', rotation='vertical',fontsize=temp)
  ax2.text( 6242.57, 0.65, 'V I', rotation='vertical',fontsize=temp)
  ax2.text( 6245.92, 0.57, 'Fe I', rotation='vertical',fontsize=temp)
  ax2.text( 6252.2, 0.565, 'Fe I', rotation='vertical',fontsize=temp)
  ax2.text( 6253.9, 0.465, 'Fe I/Si I', rotation='vertical',fontsize=temp)
  ax2.text( 6256.06, 0.51, 'Fe I/Ni I', rotation='vertical',fontsize=temp)
  ax2.text( 6258.32, 0.465, 'Fe I/Ni I', rotation='vertical',fontsize=temp)
  ax2.text( 6260.9, 0.66, 'Ti I', rotation='vertical',fontsize=temp) 
  '''
  ax2.scatter([8181.13, 8186.8,8183.26, 8184.6, 8188.1, 8192.75,8194.8, 8196.9],[0.87, 0.83, 0.7, 0.89, 0.81, 0.85,0.7, 0.89] , marker="|", c='xkcd:black', s=50)
  ax2.text( 8181.02, 0.72, 'CN Red', rotation='vertical',fontsize=temp)
  ax2.text( 8186.72 , 0.75,'Fe I', rotation='vertical',fontsize=temp)
  ax2.text( 8184.49, 0.74, 'CN Red', rotation='vertical',fontsize=temp)
  ax2.text( 8188, 0.66, 'CN Red', rotation='vertical',fontsize=temp)  
  ax2.text( 8192.65, 0.7,'CN Red', rotation='vertical',fontsize=temp)
  ax2.text( 8196.8, 0.74,'CN Red', rotation='vertical',fontsize=temp)
  ax2.text( 8183.15, 0.74,'Na I', rotation='vertical',fontsize=temp)
  ax2.text( 8194.7, 0.74,'Na I', rotation='vertical',fontsize=temp)
  ax2.set_xticks([8180, 8185, 8190, 8195,8200])
  ax2.set_xlim(centralmin, centralmax)
  ax2.legend(labels=[r'Sintético', r'Base', r'$[α/Fe]$', r'IMF', r'Observado']  ,loc="lower right")
  ax2.set_xlabel(r' $\lambda$($\AA$)', fontsize=22)
  ax2.set_ylabel(r'Fluxo Normalizado', fontsize=22)
  ax2.set_ylim(0.65, 1.1)
  ax2.fill_betweenx([0,1.2], bluemin, bluemax, facecolor='xkcd:gunmetal', edgecolor='black', alpha=0.4)
  ax2.fill_betweenx([0,1.2], centralmin, centralmax, facecolor='xkcd:greyish', edgecolor='black', alpha=0.4)
  ax2.fill_betweenx([0,1.2], redmin, redmax, facecolor='xkcd:gunmetal',edgecolor='black', alpha=0.4)
  ax2.text(centralmin+5,0.67, r'σ=300km/s', fontsize=18)
  plt.subplots_adjust(hspace=0.4)
  fig.set_figheight(8)
  fig.set_figwidth(20)
  fig.savefig(nome_linha+'central.png', bbox_inches='tight')


stack_path=os.getcwd()
stack_dir=os.listdir(stack_path)
index=[i for i in stack_dir if not i.__contains__('.')]
indice_espectral='Na8190'
index_path=stack_path+'/'+str([i for i in index if i.__contains__(indice_espectral)][0])
os.chdir(index_path)
index_dir=os.listdir(index_path)
base=[i for i in index_dir if i.__contains__('ref')]
alfa=[i for i in index_dir if i.__contains__('alfa')]
ref=[pd.read_csv(i) for i in index_dir if i.__contains__('sintetico')][0]
imf=[i for i in index_dir if i.__contains__('imf')]
empilhado=[i for i in index_dir if i.__contains__('empilhado')]
info=[i for i in index_dir if i.__contains__('info')]
info=pd.read_csv(info[0], header=None, names=['name_info', 'info'])
plota_spec(ref, empilhado, base, alfa, imf, info, indice_espectral)
plota_region(ref, empilhado, base, alfa, imf, info, indice_espectral)
